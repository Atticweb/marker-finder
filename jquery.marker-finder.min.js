!function(t,s,e,i){"use strict";function r(s,e){this.element=s,this.options=t.extend({},a,e),this._defaults=a,this._name=o,this.data={},this.map={},this.markers=[],this.markersToFilter=[],this.prevAddress={name:"",result:{}},this.searchRadius=!1,this.init()}var o="MarkerFinder",a={googleMapsKey:"",googleMapsID:"map",googleMapsOptions:{center:{lat:51.9815,lng:5.28434},zoom:6},customIcon:!1,customIconSize:!1,customIconField:"",customIconSizeField:"",latLngFields:["lat","lng"],fitBounds:!1,data:{},dataRoot:0,searchFields:["title"],onClickMarker:null,distanceUnit:"km",searchRadius:50,drawSearchRadius:!1},n=!1,h=!1,l=jQuery.Deferred();t.extend(r.prototype,{init:function(){var s=this;""==this.options.googleMapsKey&&console.warn("you forgot the googleMapsKey"),t.when(this._handleData(),this._initializeMaps()).done(function(t,e){s.map=e,s.data=t,s._drawMarkers(),l.resolve(t,e,s.markers)})},ready:function(t){return l.done(t).promise()},search:function(s,e){this.resetFilters();var i,r,o,a=new RegExp(s,"i"),n=[],h=!1,l=this.options.searchFields;if(0==s.length)return this.markersToFilter=[],this._filterMarkers(),n;for(i=0;i<this.data.length;i++){var d=!1;for(r=0;r<l.length;r++)if(t.isArray(this.data[i][l[r]])){for(o=0;o<this.data[i][l[r]].length;o++)if(-1!=this.data[i][l[r]][o].search(a)){n.push(this.data[i]),d=!0;break}}else{if(!this.data[i][l[r]]){console.error("searchField is not present in current item");break}if(-1!=this.data[i][l[r]].search(a)){n.push(this.data[i]),d=!0;break}}d?h=!0:this.markersToFilter.push(i)}return h||(this.markersToFilter=[]),this._filterMarkers(),e(n),n},getFilterValues:function(t){var s=[];for(var e in this.data)if(this.data[e][t])for(var i in this.data[e][t])-1==s.indexOf(this.data[e][t][i])&&s.push(this.data[e][t][i]);return s},setOption:function(t,s){this.options[t]=s,this.prevAddress={name:"",result:{}}},filterData:function(s,e,i){i||this.resetFilters();var r,o,a=[];for(r=0;r<this.data.length;r++){var n=!1;for(o=0;o<e.length;o++)if(-1!=this.data[r][s].indexOf(e[o])){n=!0;break}n||a.push(r)}t.extend(!0,this.markersToFilter,a),this._filterMarkers()},resetFilters:function(){this.markersToFilter=[],this._filterMarkers()},fitBounds:function(t){t=t!==i&&t?!0:!1;var s,e=new google.maps.LatLngBounds,r=!1;for(s=0;s<this.markers.length;s++)(this.markers[s].getVisible()||t)&&(e.extend(this.markers[s].getPosition()),r=!0);r&&this.map.fitBounds(e)},closestMarkers:function(t,s){var e=this,r=jQuery.Deferred(),s=s===i?!0:s,o=[];return""!==t&&t?this.prevAddress.name===t?(r.resolve(this.prevAddress.result),r):(this.prevAddress.name=t,this._getCoordsByString(t).done(function(t){return t?(e.resetFilters(),o=e._findClosestMarkers(t[e.options.latLngFields[0]],t[e.options.latLngFields[1]],s),e.options.drawSearchRadius&&e._drawSearchRadius(t[e.options.latLngFields[0]],t[e.options.latLngFields[1]],e.options.searchRadius),e.prevAddress.result=o,void r.resolve(o)):(e.resetFilters(),r.resolve(o),r)}),r):(this.resetFilters(),r.resolve(o),r)},removeSearchRadius:function(){this.searchRadius&&this.searchRadius.setMap(null)},_initializeMaps:function(){var s=jQuery.Deferred(),i=this.options.googleMapsID,r=this.options.googleMapsOptions;return n?h.done(function(){s.resolve(new google.maps.Map(e.getElementById(i),r))}):(n=!0,h=t.getScript("https://maps.googleapis.com/maps/api/js?key="+this.options.googleMapsKey).done(function(t,o){s.resolve(new google.maps.Map(e.getElementById(i),r))})),s.promise()},_handleData:function(){var s=this,e=jQuery.Deferred();return t.isPlainObject(this.options.data)?e.resolve(this._dataFromRoot()):t.getJSON(this.options.data,function(t){e.resolve(s._dataFromRoot(t))}).error(function(t,s,e){console.warn("error "+s)}),e.promise()},_getCoordsByString:function(t){var s=jQuery.Deferred(),e=new google.maps.Geocoder;return e.geocode({address:t},function(t,e){e==google.maps.GeocoderStatus.OK?s.resolve({lat:t[0].geometry.location.lat(),lng:t[0].geometry.location.lng()}):s.resolve(!1)}),s},_rad:function(t){return t*Math.PI/180},_findClosestMarkers:function(t,s,e){var i,r="km"==this.options.distanceUnit?6378:3963,o=[];for(i=0;i<this.markers.length;i++){var a=this.markers[i].position.lat(),n=this.markers[i].position.lng(),h=this._rad(a-t),l=this._rad(n-s),d=Math.sin(h/2)*Math.sin(h/2)+Math.cos(this._rad(t))*Math.cos(this._rad(t))*Math.sin(l/2)*Math.sin(l/2),c=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)),u=r*c;u<this.options.searchRadius?o.push({data:this.data[i],marker:this.markers[i],distance:Math.ceil(u)}):e&&this.markersToFilter.push(this.markers[i].id)}return e&&this._filterMarkers(),o.sort(function(t,s){return t.distance-s.distance}),o},_drawSearchRadius:function(t,s,e){this.removeSearchRadius(),this.searchRadius=new google.maps.Circle({fillColor:"#FF0000",fillOpacity:.2,strokeWeight:0,map:this.map,center:{lat:t,lng:s},radius:1e3*e})},_drawMarkers:function(){var t,s,e,i,r;for(t=0;t<this.data.length;t++)e=this.data[t],s={position:new google.maps.LatLng(e[this.options.latLngFields[0]],e[this.options.latLngFields[1]]),map:this.map,title:e.title},""!=this.options.customIconField&&this.options.customIconField?(s.icon={},s.icon.url=e[this.options.customIconField]):""!=this.options.customIcon&&this.options.customIcon&&(s.icon={},s.icon.url=e[this.options.customIcon]),!s.icon||""==this.options.customIconSizeField&&""==this.options.customIconSize||(r=""!=this.options.customIconSizeField?e[this.options.customIconSizeField].split(","):this.options.customIconSize.split(","),s.icon.scaledSize=new google.maps.Size(parseInt(r[0]),parseInt(r[1]))),i=new google.maps.Marker(s),i.set("id",t),this.markers.push(i);this._setMarkerProperties(),this.options.fitBounds&&this.fitBounds()},_filterMarkers:function(){var t;for(t=0;t<this.markers.length;t++)this.markers[t].setVisible(-1==this.markersToFilter.indexOf(t))},_setMarkerProperties:function(){var t,s=this;for(t=0;t<this.markers.length;t++)google.maps.event.addListener(this.markers[t],"click",function(){s.options.onClickMarker&&s.options.onClickMarker.call(this,s.data[this.get("id")])})},_dataFromRoot:function(t,s){var e,t=t!==i?t:this.data,s=s!==i?s:this.options.dataRoot,r=s.split(".");if(-1===s.indexOf("."))return t[s];for(e=0;e<r.length;e++){if(!t[r[e]]){console.error("the dataRoot is not correct");break}t=t[r[e]]}return t}}),t.fn[o]=function(s){var e,a,n=arguments;return s===i||"object"==typeof s?this.each(function(){t.data(this,"plugin_"+o)||t.data(this,"plugin_"+o,new r(this,s))}):"string"==typeof s&&"_"!==s[0]&&"init"!==s?(this.each(function(){a=t.data(this,"plugin_"+o),a instanceof r&&"function"==typeof a[s]&&(e=a[s].apply(a,Array.prototype.slice.call(n,1))),"destroy"===s&&t.data(this,"plugin_"+o,null)}),e!==i?e:this):void 0}}(jQuery,window,document);